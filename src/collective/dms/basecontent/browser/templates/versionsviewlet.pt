<div id="fieldset-versions" style="float:right; width: 50%;">
<fieldset>
  <legend i18n:translate=""
    tal:content="view/label">label</legend>
    <tal:listing define="results view/table/values">
      <tal:b condition="results">
        <table tal:replace="structure view/table/render" />
        <div tal:define="version python:results[0].getObject()"
             tal:replace="structure version/@@versionviewer" />
      </tal:b>
      <tal:b condition="not:results" replace="view/noresult_message" />
    </tal:listing>
</fieldset>
<script type="text/javascript">
$(document).ready(function(){
    var initial_timeout = null;
    documentviewer = document.querySelector('.pat2-documentviewer');
    if (documentviewer) {
      options = JSON.parse(documentviewer.getAttribute('data-pat-documentviewer'));
      console.log('FIRST with options:', options);
      options.container = documentviewer;
      DV.load(options.data, options);
    }

    $('.version-link').closest('tr').bind('select-version', function() {
      /* a version has been selected, disable initial timeout */
      window.clearTimeout(initial_timeout);
      initial_timeout = null;

      var trigger = $(this).find('a.version-link');
      if (trigger.closest('tr').hasClass('selected')) {
        // the version is already selected, no need to reload it
        return;
      }
      var url = trigger.attr('href') + '/@@dvdata';
      $.getJSON(url, function(options) {
        console.log('Loading document viewer with options:', options);
        documentviewer = document.querySelector('.pat2-documentviewer');
        documentviewer.setAttribute('data-pat-documentviewer', JSON.stringify(options));
        options.container = documentviewer;
        DV.load(options.data, options);
        $('table.dv').find('tr').removeClass('selected');
        trigger.closest('tr').addClass('selected');
      });
    });

    function async_load_dv() {
      // click on the first version if no version was selected by the user
      // within the 6s.
      $(".version-link:first").closest('tr').trigger('select-version');
    }

    if (documentviewer == null) {
      // the version was just added, update DV after 6s
      initial_timeout = setTimeout(async_load_dv, 6000);
    } else {
      $(".version-link:first").closest('tr').addClass('selected').trigger('select-version');
    }

    $(".version-link").closest('tr').click(function(){
      $(this).closest('tr').trigger('select-version');
    });
    $(".version-link").click(function(){
      $(this).closest('tr').trigger('select-version');
      return false;
    });
});
</script>
</div>
